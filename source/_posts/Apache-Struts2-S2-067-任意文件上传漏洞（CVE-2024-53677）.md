---
title: Apache Struts2 S2-067 任意文件上传漏洞（CVE-2024-53677）
tags:
  - Apache Struts2
  - s2-067
  - CVE-2024-53677
  - 任意文件上传
categories:
  - - 漏洞分析
top: 204
description: 本文介绍了 Apache Struts2 S2-067 任意文件上传漏洞（CVE-2024-53677）的漏洞成因
abbrlink: 60a726cc
date: 2025-04-25 21:39:58
---
# 漏洞描述
Apache Struts是美国阿帕奇（Apache）基金会的一个开源项目，是一套用于创建企业级Java Web应用的开源MVC框架。  
Apache Struts在特定条件下，存在文件上传漏洞（网宿评分：高危、CVSS 3.0 评分：8.1）：
攻击者可以操纵文件上传参数来实现路径遍历，在某些情况下，这可能导致恶意文件上传。  
# 影响版本
Struts 2.0.0 - 2.3.37（EOL）  
Struts 2.5.0 - 2.5.33（EOL）  
Struts 6.0.0 - 6.3.0.2  
# 环境搭建
同`S2-066`  
# 漏洞成因
`S2-067`与`S2-066`有90%的相似，`S2-067`是`S2-066`补丁的绕过。  
通过前一篇文章的分析我们直到`S2-066`的修复是在向`ActionContext`的`parameters`属性添加一个参数，先检查`parameters`属性是否为空，如果为空，则直接添加参数，  
如果`parameters`不为空，则遍历文件上传的参数`ContentType`与`UploadFileName`等，将其先同意转换为小写，然后在与`parameters`中的元素比较，  
当存在相同的元素的时候先删除`parameters`中的参数再将新的参数添加到`parameters`中，这样就避免了用户上传表单中非文件参数对文件上传参数的影响覆盖。  
通过对`S2-066`的学习我们还可以直到，form表单参数的`name`属性的值会被当作`OGNL`解析，用来向`ValueStack`上的`root`映射中的元素设置属性值。  
既如此，`name`属性的值就可以是任何有效的`OGNL`表达式，从而实现任意属性的设置。  
当我们使用这样的表达是的时候`top.uploadFileName`会发生什么。  
让我们定位到`com.opensymphony.xwork2.interceptor.ParametersInterceptor.setParameters`方法  
这里面调用了`ValueStack`的`setParameter`方法向`ValueStack`的`root`映射中设置属性值。  
```java
protected void setParameters(final Object action, ValueStack stack, HttpParameters parameters) {

        for (Map.Entry<String, Parameter> entry : acceptableParameters.entrySet()) {
            String name = entry.getKey();
            Parameter value = entry.getValue();
            try {
                newStack.setParameter(name, value.getObject()); // name == top.uploadFileName
            } catch (RuntimeException e) {
                if (devMode) {
                    notifyDeveloperParameterException(action, name, e.getMessage());
                }
            }
        }
    ...
    }
```
通过`setParaameters`的方法签名也可以看出来其第一个参数是一个`OGNL`表达式。
```java
public void setParameter(String expr, Object value) {
        setValue(expr, value, devMode);
    }
```
程序继续向下执行最终会来到 `com.opensymphony.xwork2.ognl.OgnlUtil.compileAndExecute`方法。  
这个方法会根据`ognl`表达式来获取`ognl`表达式对应的`ognl`树，然后解析`ognl`树。  
当`ognl`表达式为`uploadFileName`的时候，得到的`tree`为`ASTProperty`类型，`S2-066`就是执行`ASTProperty`的`setValueBody`方法设置`ValueStack` 的`root`映射中的元素。  
当`ognl`表达式为`top.uploadFileName`的时候，得到的`tree`为`ASTChain`类型，`S2-067`就是执行`ASTChain`的`setValueBody`方法设置`ValueStack` 的`root`映射中的元素。
```java
private <T> Object compileAndExecute(String expression, Map<String, Object> context, OgnlTask<T> task) throws OgnlException {
        Object tree;
        if (enableExpressionCache) {
            tree = expressions.get(expression);
            if (tree == null) {
                tree = Ognl.parseExpression(expression);
                checkEnableEvalExpression(tree, context);
            }
        } else {
            tree = Ognl.parseExpression(expression);
            checkEnableEvalExpression(tree, context);
        }

        final T exec = task.execute(tree);
        // if cache is enabled and it's a valid expression, puts it in
        if (enableExpressionCache) {
            expressions.putIfAbsent(expression, tree);
        }
        return exec;
    }
```
`ASTChain`的`setValueBody`方法    
```java
protected void setValueBody(OgnlContext context, Object target, Object value) throws OgnlException {
        boolean handled = false;
        int i = 0;

        for(int ilast = this._children.length - 2; i <= ilast; ++i) {
            ...

            if (!handled) {
                target = this._children[i].getValue(context, target);
            }
        }

        if (!handled) {
            this._children[this._children.length - 1].setValue(context, target, value);
        }

    }
```
`ASTChain`的`Children`包含两个元素均为`ASTProperty`类型，就是通过`.`将`top.uploadFileName`进行了分割成两部分。  
首先通过`top`节点去取`target`的值，注意这里`target`之前是有值的就是`ValueStack`的`root`映射部分，即一个`CompoundRoot`对象，包含两个元素  
`UploadAction`以及`DefaultTextProvider`对象。这里也就是通过`top`节点取取一个值来覆盖原来的`target`。  
![img.png](img.png)  
代码继续向下执行会来到`com.opensymphony.xwork2.ognl.accessor.CompoundRootAccessor.getProperty`方法。  
这里判断`name`是否为`top`，如果为`top`则返回`root`的第一个元素，否则会遍历`root`中的元素，如果元素中有`name`属性则返回该元素。  
`root`的第一个元素即为`UploadAction`，即上一步求的`target`为`UploadAction`。  
```java
public Object getProperty(Map context, Object target, Object name) throws OgnlException {
        CompoundRoot root = (CompoundRoot) target;
        OgnlContext ognlContext = (OgnlContext) context;

        if (name instanceof Integer) {
            Integer index = (Integer) name;
            return root.cutStack(index);
        } else if (name instanceof String) {
            if ("top".equals(name)) {
                if (root.size() > 0) {
                    return root.get(0);
                } else {
                    return null;
                }
            }

            for (Object o : root) {
                if (o == null) {
                    continue;
                }

                try {
                    if ((OgnlRuntime.hasGetProperty(ognlContext, o, name)) || ((o instanceof Map) && ((Map) o).containsKey(name))) {
                        return OgnlRuntime.getProperty(ognlContext, o, name);
                    }
                } catch (OgnlException e) {
                    if (e.getReason() != null) {
                        final String msg = "Caught an Ognl exception while getting property " + name;
                        throw new XWorkException(msg, e);
                    }
                } catch (IntrospectionException e) {
                    // this is OK if this happens, we'll just keep trying the next
                }
            }

            //property was not found
            if (context.containsKey(OgnlValueStack.THROW_EXCEPTION_ON_FAILURE))
                throw new NoSuchPropertyException(target, name);
            else
                return null;
        } else {
            return null;
        }
    }
```
重新求得`target`后则会调用`uploadFileName`的节点得`setValue`方法为`target`设置值。  
`uploadFileName`节点是`ASTProperty`类型，这就是典型得`OGNL`表达式的语法了，后面的内容就与`S2-066`的逻辑一致了。  
因为在`S2-067`中我们使用的`payload`是`top.uploadFileName`与`UploadFileName`在统一大小写后也并不相等，所以就能完美的绕过`S2-066`添加的`remove`方法的补丁了。  
```java
 this._children[this._children.length - 1].setValue(context, target, value);
```
另外，`ValueStack`的`root`映射中包含两个元素，一个是`UploadAction`，一个是`DefaultTextProvider`，既然`UploadAction`的属性可以被设置，那么`DefaultTextProvider`的属性也是可以被设置的。  
这样我们就可以控制`DefaultTextProvider`对象的属性值，是不是可以做些什么呢？
# 漏洞修复
新增了一个类并被推荐使用。。。。FileUploadAction并没有被修改，应该是这样的。赶时间
# 参考链接
无